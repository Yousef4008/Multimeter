/*	____________________________________________________________________________
  |																			    |
  | Driver: Current Meter													    |
  |																			    |
  | File Name: current_meter.c												    |
  |																			    |
  | Description: Source file for current meter driver						    |
  |																			    |
  | Author: Youssif Hossam													    |
  |_____________________________________________________________________________|
 */

#include "current_meter.h"

/*______________________________________________________________________________
 |                               Functions Definitions                          |
 |______________________________________________________________________________|
 */

/*
 * Description :
 * -> Function responsible for getting the current reading.
 * -> This function measures the current by reading the ADC values multiple times,
 *    averaging the results, and applying the appropriate conversion to obtain
 *    the current in amperes.
 */
float CURRENT_METER_getReading(ADS1015 * ads){
	float current = 0;
	uint16 adc;
	uint8 count = 0;
	do{
		current = 0;
	/* Read the ADC values and accumulate */
	for(uint8 i = 0 ; i < CURRENT_METER_VOLTAGE_MEASUREMENT_COUNT ; i++){
		adc = ADS1015_readADC_SingleEnded(ads, CURRENT_METER_VOUT_ADS_CHANNEL_NUM);
		if(adc > 0){
		current += ((float)adc / 333);
		count++;
		}
	}

	/* Calculate the average ADC value */
	current /= count;

	/* Convert the averaged ADC value to current */
	current = ((current - 2.5015) / CURRENT_METER_ACS712ELCTR_20A_T_SENSITIVITY);
	}while(current < 0);
	return current;
}
