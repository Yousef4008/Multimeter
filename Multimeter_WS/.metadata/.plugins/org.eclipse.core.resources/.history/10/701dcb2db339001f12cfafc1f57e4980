/*
 * inductance_meter.c
 *
 *  Created on: Jul 4, 2024
 *      Author: Youssif Hossam
 */


#include "inductance_meter.h"
#include <util/delay.h>
#include <math.h>

float INDUCTANCE_METER_getReading(){
	float iductance;
	Timer1_ConfigType Timer1_Config = {0, 0, NO_PRESCALER, NORMAL_MODE};

	GPIO_writePin(INDUCTANCE_METER_CHARGING_PORT_ID, INDUCTANCE_METER_CHARGING_PIN_ID, LOGIC_HIGH);
	_delay_ms(5);
	GPIO_writePin(INDUCTANCE_METER_CHARGING_PORT_ID, INDUCTANCE_METER_CHARGING_PIN_ID, LOGIC_LOW);

	if(GPIO_readPin(INDUCTANCE_METER_COMPARATOR_PORT_ID, PIN3_ID) == LOGIC_HIGH){
		while(GPIO_readPin(INDUCTANCE_METER_COMPARATOR_PORT_ID, INDUCTANCE_METER_COMPARATOR_PIN_ID) == LOGIC_HIGH);
		Timer1_init(&Timer1_Config);
		while(GPIO_readPin(INDUCTANCE_METER_COMPARATOR_PORT_ID, INDUCTANCE_METER_COMPARATOR_PIN_ID) == LOGIC_LOW);
		while(GPIO_readPin(INDUCTANCE_METER_COMPARATOR_PORT_ID, INDUCTANCE_METER_COMPARATOR_PIN_ID) == LOGIC_HIGH);
		while(GPIO_readPin(INDUCTANCE_METER_COMPARATOR_PORT_ID, INDUCTANCE_METER_COMPARATOR_PIN_ID) == LOGIC_LOW);
		while(GPIO_readPin(INDUCTANCE_METER_COMPARATOR_PORT_ID, INDUCTANCE_METER_COMPARATOR_PIN_ID) == LOGIC_HIGH);
		iductance = Timer1_getCount();
		Timer1_deInit();
	}
	else{
		while(GPIO_readPin(PORTA_ID, PIN3_ID) == LOGIC_LOW);
		Timer1_init(&Timer1_Config);
		while(GPIO_readPin(PORTA_ID, PIN3_ID) == LOGIC_HIGH);
		while(GPIO_readPin(PORTA_ID, PIN3_ID) == LOGIC_LOW);
		while(GPIO_readPin(PORTA_ID, PIN3_ID) == LOGIC_HIGH);
		while(GPIO_readPin(PORTA_ID, PIN3_ID) == LOGIC_LOW);
		iductance = Timer1_getCount();
		Timer1_deInit();
	}
	iductance /= (F_CPU_MEGA_HZ*2);
	iductance = (iductance*iductance)/(4*(M_PI*M_PI)*INDUCTANCE_METER_CAPACITOR_MICROFARAD_VALUE);

	return iductance;
}
